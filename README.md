# 🎮 M68k Tetris プログラム仕様書

M68k実験ボードおよび自作マルチタスクモニタ（`mtk_c`）上で動作する，コンソールベースのテトリス風パズルゲームです．
VT100エスケープシーケンスを使用し，カラー表示とカーソル制御による動的な描画を実現しています．

## 📝 概要
本プログラムは，組込み環境（M68k）におけるリアルタイム処理と描画制御の実装例です．
マルチタスクカーネル上で動作し，CPUリソースを他のタスクと共有しながらゲームロジックを実行します．

## 🛠️ 動作環境
* **プラットフォーム**: M68k実験ボード
* **OS/カーネル**: 自作マルチタスクモニタ (`mtk_c`)
* **端末仕様**: VT100互換のエスケープシーケンス（カラー，カーソル移動）に対応したターミナル

## 📐 基本仕様

### 画面構成
* **フィールドサイズ**: 幅12ブロック × 高さ22ブロック
    * **有効エリア**: 幅10 × 高さ21（周囲は壁と床で囲まれています）
* **描画文字**:
    * ブロック: `[]` （各ミノ固有色）
    * 壁・床: `[]` （白色 `\x1b[37m`）
    * 空白: ` .`

### 🕹️ 操作方法
キーボード入力（ノンブロッキング）により操作します．

| キー | 動作 | 備考 |
| :---: | :--- | :--- |
| **`a`** | ⬅️ 左移動 | 左に壁やブロックがある場合は移動しない． |
| **`d`** | ➡️ 右移動 | 右に壁やブロックがある場合は移動しない． |
| **`s`** | ⬇️ 下移動 | 高速落下（ソフトドロップ）． |
| **Space** | 🔄 回転 | 時計回りに90度回転．回転不可の場合は何もしない． |

## ⚙️ 詳細機能仕様

### ミノ（テトロミノ）の定義
以下の7種類の形状を実装しています．各ミノは固有の色を持ちます．

| ID | タイプ | 形 | 色 | エスケープシーケンス色名 |
|:--:|:--:|:--:|:---|:---|
| 0 | **I** | 直線 | 水色 | Cyan |
| 1 | **O** | 正方形 | 黄色 | Yellow |
| 2 | **S** | S字 | 緑 | Green |
| 3 | **Z** | Z字 | 赤 | Red |
| 4 | **J** | J字 | 青 | Blue |
| 5 | **L** | L字 | 紫 | Magenta |
| 6 | **T** | T字 | 白 | White |

### ゲーム進行ロジック
1.  **初期化**
    * 画面クリア (`ESC_CLS`) およびカーソル非表示化 (`ESC_HIDE_CUR`)．
    * フィールド配列の初期化（壁と床の設置）．
2.  **スポーン**
    * ランダムな種類のミノを上部（x=5, y=0）に出現させる．
    * 出現時点で衝突している場合は **GAME OVER** とする．
3.  **落下と移動**
    * 一定時間（`tick`依存）ごとに自動で1段落下する．
    * ユーザ入力により左右移動・回転・強制落下が可能．
4.  **固定と判定**
    * 落下先に壁または既存ブロックがある場合，その位置にミノを固定する．
    * **ライン消去**: 横一列がすべて埋まっているか判定し，埋まっている場合はその行を消去し，上部のブロックを詰める．
5.  **ループ**
    * 固定後，新しいミノをスポーンさせる．
    * ゲームオーバー時は「GAME OVER」を表示し，盤面をリセットして再開する．

### 内部データ構造
* **フィールドデータ (`field[22][12]`)**
    * `0`: 空白
    * `1`: 壁または床
    * `2`〜`8`: 固定されたブロック（値は `ミノタイプ + 2` に対応）
* **描画バッファ (`displayBuffer[22][12]`)**
    * チラつき防止のため，フィールドデータと操作中のミノデータを合成した一時バッファを使用して描画を行う．

### マルチタスク対応
* **入力**: `inbyte(0)` によるノンブロッキング入力待ちを使用．
* **CPU譲渡**: ループ毎に `skipmt()` を呼び出し，CPUリソースを他のタスクへ譲渡する協調的マルチタスク動作を行う．

## 🔧 カスタマイズ
ソースコード内の定数を変更することで，以下の調整が可能です．

* **落下速度**: `game_task` 内の `next_drop_time = tick + 1;` の数値を増やすと遅くなります．
* **フィールドサイズ**: `FIELD_WIDTH`, `FIELD_HEIGHT` マクロで変更可能．
