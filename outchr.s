/* ===================================================================
 * outchr.s
 * 1文字出力ルーチン
 * =================================================================== */

.include "equdefs.inc"

    .global outbyte
    .text
    .even

/* ===================================================================
 * outbyte(int ch, unsigned char c)
 * シリアルポートへの1文字出力
 *
 * 引数:
 * ch: チャンネル番号 (0=UART1, 1=UART2)
 * c : 出力する文字
 * =================================================================== */
outbyte:
    /* ---------------------------------------------------------------
     * 1. スタックフレーム作成とレジスタ退避
     * ローカルバッファ領域(4バイト)を確保: -4(%a6)
     * --------------------------------------------------------------- */
    link    %a6, #-4
    movem.l %d2-%d7/%a2-%a5, -(%sp)

    /* ---------------------------------------------------------------
     * 2. 引数の取得とバッファへの格納
     * --------------------------------------------------------------- */
    /* 第2引数 c (12(%a6)) を取得してスタック上のバッファへコピー */
    move.l  12(%a6), %d0
    move.b  %d0, -4(%a6)

    /* ---------------------------------------------------------------
     * 3. システムコール (PUTSTRING) の準備
     * --------------------------------------------------------------- */
    move.l  #SYSCALL_NUM_PUTSTRING, %d0
    
    /* 第1引数 ch (8(%a6)) を取得して %d1 にセット */
    move.l  8(%a6), %d1
    
    /* 出力バッファのアドレス (-4(%a6)) を %d2 にセット */
    lea     -4(%a6), %a0
    move.l  %a0, %d2
    
    /* 出力サイズ (1バイト) を %d3 にセット */
    move.l  #1, %d3
    
    /* ---------------------------------------------------------------
     * 4. システムコール実行
     * trap #0
     * --------------------------------------------------------------- */
    trap    #0

    /* ---------------------------------------------------------------
     * 5. レジスタ復帰とリターン
     * --------------------------------------------------------------- */
    movem.l (%sp)+, %d2-%d7/%a2-%a5
    unlk    %a6
    rts