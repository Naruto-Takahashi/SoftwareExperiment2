/* ===================================================================
 * inchrw.s
 * 1文字入力ルーチン
 * =================================================================== */

.include "equdefs.inc"

    .global inbyte
    .text
    .even

/* ===================================================================
 * inbyte(int ch)
 * シリアルポートからの1文字入力
 *
 * 引数:
 * ch: チャンネル番号 (0=UART1, 1=UART2)
 * 戻り値:
 * 0〜255: 受信した文字コード
 * -1    : データなし (ノンブロッキング)
 * =================================================================== */
inbyte:
    /* ---------------------------------------------------------------
     * 1. スタックフレーム作成とレジスタ退避
     * ローカル変数領域(2バイト)を確保: -2(%a6)
     * --------------------------------------------------------------- */
    link    %a6, #-2
    movem.l %d2-%d3, -(%sp)

    /* ---------------------------------------------------------------
     * 2. システムコール (GETSTRING) の準備
     * --------------------------------------------------------------- */
    move.l  #SYSCALL_NUM_GETSTRING, %d0
    
    /* 第1引数 ch をスタックから取得して %d1 にセット */
    move.l  8(%a6), %d1
    
    /* 受信バッファのアドレス (-2(%a6)) を %d2 にセット */
    lea     -2(%a6), %a0
    move.l  %a0, %d2
    
    /* 読み込むサイズ (1バイト) を %d3 にセット */
    move.l  #1, %d3
    
    /* ---------------------------------------------------------------
     * 3. システムコール実行
     * trap #0
     * --------------------------------------------------------------- */
    trap    #0

    /* ---------------------------------------------------------------
     * 4. 結果判定と戻り値設定
     * %d0 には読み込んだバイト数が返る (0 または 1)
     * --------------------------------------------------------------- */
    tst.l   %d0
    bne     data_found      /* データがあれば (%d0 > 0) 分岐 */

no_data:
    /* データなしの場合 */
    moveq.l #-1, %d0        /* 戻り値を -1 に設定 */
    bra     inbyte_exit     /* 終了へ */

data_found:
    /* データありの場合 */
    moveq.l #0, %d0         /* 上位ビットクリア */
    move.b  -2(%a6), %d0    /* 受信した1バイトを戻り値(%d0)にセット */

inbyte_exit:
    /* ---------------------------------------------------------------
     * 5. レジスタ復帰とリターン
     * --------------------------------------------------------------- */
    movem.l (%sp)+, %d2-%d3
    unlk    %a6
    rts